---
title: "Spatial Economics -- Assignment 3"
author:
  - "Gustav Pirich (h11910449)"
  - "Gabriel Konecny (h11775903)"
date: "April 2, 2024"
output:
  pdf_document:
    toc: true
    includes:
      in_header: !expr file.path("~/Desktop/GITHUB/spatial_econ/helper/wraper_code.tex")
bibliography: references.bib
nocite: '@*'
header-includes:
  - \usepackage{tcolorbox}
  - \usepackage[default]{lato}
  - \usepackage{rotating}
papersize: a4
geometry: margin=2cm
urlcolor: DarkOrchid!65!black
---


```{r, setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 80), tidy = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
library(showtext)
showtext_auto()

pacman::p_load(spatialreg, fixest, splm, stringi, stringr, stringdist, haven, sf, dplyr, fuzzyjoin, 
               comparator, digest, zoomerjoin, ggplot2, tidyr, ggthemes, viridis, 
               fixest, conleyreg, plm, stargazer, magrittr, tidyverse, tmap, spdep, SDPDmod,
               igraph, generics, knitr, kableExtra, formatR,readxl, haven)
```

\vspace{2em}

\begin{tcolorbox}
\centering \itshape The code that was used in compiling the assignment is available on GitHub at \url{https://github.com/gustavpirich/spatial_econ/blob/main/03_assignment/03_assignmnet.Rmd}.
\end{tcolorbox}

\newpage


# Exercise A
```{r, echo=FALSE}
cigar_states <- readxl::read_excel(file.path("data","cigarettes","cigar_states.xls"))
cigarette_2var <- readxl::read_excel(file.path("data","cigarettes","cigarette+2var.xls")) %>%
                        fastDummies::dummy_cols(select_columns = "year") %>%
                        fastDummies::dummy_cols(select_columns = "state")
W <- as.matrix(readxl::read_excel(file.path("data","cigarettes","Spat-Sym-US.xls"), col_names=FALSE), dimnames=FALSE)
```

 Estimate the demand model, and test for spatial dependence using the procedures discussed in class, and the provided weights matrix. Suppress any theoretical considerations
— which model would the classical specification search prefer?

```{r}
data_OLS <- select(cigarette_2var, c(logc, logp,logy, starts_with("year_")|starts_with("state_")))
OLS <- lm(logc ~ ., data_OLS)
```

```{r}
W_tilde <- kronecker(diag(nrow(unique(cigarette_2var[,"year"]))), W)
W_list <- mat2listw(W_tilde)
```

```{r}
lm.morantest(OLS, listw = W.list,alternative = "greater", zero.policy=TRUE)
```


# Exercise B
```{r, eval=FALSE}
setwd("~/Desktop/GITHUB/spatial_econ/data/03_assignment/dataset")

raster_Africa <- read_sf("~/Desktop/GITHUB/spatial_econ/data/03_assignment/dataset/raster_Africa.shp")

geoconflict_main <- read_dta("~/Desktop/GITHUB/spatial_econ/data/03_assignment/dataset/geoconflict_main.dta")

intersect_coord <- read_dta("~/Desktop/GITHUB/spatial_econ/data/03_assignment/dataset/intersect_coord.dta")
```

## Unit of Observation
```{r, echo = FALSE}
area <- st_area(raster_Africa)

raster_Africa %>%
  mutate(area = st_area(geometry))

data <- data.frame(Cells = c("Min", "Mean", "Median", "Max"), Stats = c(min(area), mean(area), median(area), max(area)))

kable(data)
```
The unit of observation are cells in a raster representing a 1×1 degree latitude longitude grid cover. At the equator this corresponds to a side length of 110 km. The areal extension of the cells varies with latitude. Further away from the equator, the area of a cell decreases. 
The table shows the area of the cells. The smallest cell has an area of about 97 857 $km^{2}$, the largest 12 364 $km^{2}$. On average the size of the cells is 11 900 $km^{2}$.  Thus the gap between the smallest and largest cell amounts to about 20%.
They differ because of the distortions induced by the projection of the surface of the earth, onto a 2 dimensional raster grid. 

## Interpretation of Coefficients

## Replication

```{r}
nblist <- poly2nb(raster_Africa, queen = TRUE)


nb.dist.band <- dnearneigh(raster_Africa, 0, 180)

nblist <- dnearneigh(x = st_centroid(raster_Africa), d1 = 0, d2 = 180, longlat = TRUE)

nbw <- nb2listw(nblist, style = "B", zero.policy = TRUE)

weightmatrix <- listw2mat(nbw)


# Defining hte bianry contiguity matrix with a distance cutoff of 180km

library(units)

# Setting a 180 km cutoff
dist_matrix <- st_distance(raster_Africa)

distance_threshold <- set_units(180000, "m")  # 180,000 meters

contiguity_matrix <- as.matrix(dist_matrix) <= distance_threshold  # distance in meters
binary_matrix <- ifelse(contiguity_matrix, 1, 0)

# Remove diagonal elements to avoid self-neighboring
diag(binary_matrix) <- 0

# Dynamic spatial panel model using maximum likelihood
model <- spml(ANY_EVENT_ACLED ~ SPEI4pg + GSmain_ext_SPEI4pg +W_L2_GSmain_ext_SPEI4pg, 
              data = geoconflict_main, 
              index = c("cell", "year"), 
              listw = nbw, 
              model = "lag", 
              effect = "random", 
              method = "ML")
summary(model)

res2  <- blmpSDPD(formula = "ANY_EVENT_ACLED ~ SPEI4pg + GSmain_ext_SPEI4pg",
                 data = geoconflict_main,
                 W = binary_matrix,
                 model = list("sar", "sdm", "sem", "sdem"),
                 index = c("cell","year"),
                 model = list("sdm"),
                 effect = "twoways", dynamic = TRUE)
res2

# Convert DataFrame to pdata.frame for plm package
pdata <- pdata.frame(df, index = c("id", "time"))

# Create a spatial weights matrix (W)
# For example, using queen contiguity:
coordinates <- as.matrix(df[, c("longitude", "latitude")])
nb <- poly2nb(coordinates, queen = TRUE)
W <- nb2listw(nb, style = "W", zero.policy = TRUE)


listw <- mat2listw(binary_matrix, style = "W", zero.policy = TRUE)


blmpSDPD(ANY_EVENT_ACLED ~ SPEI4pg + L1_SPEI4pg + L2_SPEI4pg, index = c("cell", "year"), dynamic = TRUE, W = listw, data = geoconflict_main)


reg6 <- lagsarlm(ANY_EVENT_ACLED ~ SPEI4pg + GSmain_ext_SPEI4pg, data = geoconflict_main, zero.policy = TRUE, weightmatrix, type="mixed")
summary(reg6)

summary(impacts(COL.SLX))
```